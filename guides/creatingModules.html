---
layout: guideslayout
published: true
title: Creating a Module
---


<div class="row">
    <div class="col-md-12">

        <h2>Prerequisites</h2>

        <p>In order for the CitySDK to consume an API with JavaScript, there are a few prerequisites.</p>

        <div class="row">
            <div class="col-md-6">
                <h3>CORS or JSONP
                    <small><span class="label label-danger">Critical</span></small>
                </h3>
                <p>The CitySDK runs in a browser using JavaScript. In order to avoid any cross-domain security blocks
                    the API must run on servers with appropriate CORS headers or have support for JSONP.</p>

                <p>You can learn more about CORS <a href="http://enable-cors.org/" class="btn btn-primary btn-xs"
                                                    target="_blank">here</a>.</p>

                <p>You can test your API's CORS support <a href="http://test-cors.org/" class="btn btn-primary btn-xs"
                                                           target="_blank">here</a>.</p>
            </div>
            <div class="col-md-6">
                <h3>SSL
                    <small><span class="label label-warning">Important</span></small>
                </h3>
                <p>While not mandatory, it is <strong>STRONGLY</strong> recommended that the underlying API support SSL.
                    Most modern websites support and some mandate the use of SSL (https). If the API only supports http
                    then any application built on top of that API using javascript will likely <em>malfunction when
                        viewed over a secure connection</em> (which is now a default result for many google searches).
                </p>

                <div class="alert alert-warning" role="alert">
                    <p><strong>Note:</strong> SSL certificates should be valid to all browsers and NOT self-signed or
                        organization signed.</p>
                </div>
            </div>
        </div>


        <h2>Module Anatomy</h2>

        <p>Modules all follow the same basic overall structure. The file should be named <span class="text-primary">citysdk.<em>modulename</em>.js</span>.
        </p>

        <h3>Definition</h3>

        <p>This creates the module's name and initial state. Outside of the module name, there isn't a lot of divergence
            between modules here.</p>

        <pre>
    CitySDK.prototype.modules.<em>modulename</em> = new ModuleTemplateModule();

    function ModuleTemplateModule() {
        this.enabled = false;
    };
</pre>

        <h3>Settings</h3>

        <p>The API endpoints, and any controllable settings should be defined here. This can include any manually set
            values, validation data, and/or arrays. An example of a module setting is the alias list in the Census
            module.</p>

        <pre>
    // Endpoint URLS
    ModuleTemplateModule.prototype.DEFAULT_ENDPOINTS = {};
    ModuleTemplateModule.prototype.DEFAULT_ENDPOINTS.apiURL = "https://urloftheapi.com/";
    // DO NOT hardcode endpoint URLS into function.

    // Version Numbers
    ModuleTemplateModule.prototype.version = 1.0;
    ModuleTemplateModule.prototype.minCoreVersionRequired = 1.5;
</pre>

        <h3>Enable</h3>

        <p>The enable function is where the API key is input and set. This is also the function that can be used for any
            required initialization. The enable function also compares the current version of the CitySDK core against
            the minimum version required by the module.</p>

        <pre>
    ModuleTemplateModule.prototype.enable = function(<var>apiKey</var>) {
        this.apiKey = apiKey;

        if (CitySDK.prototype.sdkInstance.version >= this.minCoreVersionRequired) {
            this.enabled = true;
            return true;
        } else {
            this.enabled = false;
            return false;
        }
    };
</pre>

        <h3>APIRequest()</h3>

        <div class="row">
            <div class="col-md-8">
                <p>This is the fundamental request for data. The central data request mechanism of the module should use
                    this function name. It is recommended to make use of the caching mechanism demonstrated in the
                    module template but it is not required.</p>
            </div>
            <div class="col-md-4">
                <div class="alert alert-warning" role="alert">
                    <p><strong>Important:</strong> DO NOT hardcode the URL of the API inside the
                        <code>APIRequest()</code> function. Use the module settings instead.</p>
                </div>
            </div>
        </div>



        <pre>
    ModuleTemplateModule.prototype.APIRequest = function(<var>request</var>, <var>callback</var>) {
    var <var>cacheKey</var> = "unique key to determine how to cache the returned data";

    CitySDK.prototype.sdkInstance.getCachedData("<em>modulename</em>", "APIRequest", <var>cacheKey</var>, function (<var>cachedData</var>) {
        if (cachedData != null) {
            callback(<var>cachedData</var>);
            return;
        } else {
            var <var>URL</var> = CitySDK.prototype.modules.<em>modulename</em>.DEFAULT_ENDPOINTS.apiURL;
            CitySDK.prototype.sdkInstance.ajaxRequest(<var>URL</var>).done(
                function (<var>response</var>) {
                    <var>response</var> = jQuery.parseJSON(<var>response</var>);
                    CitySDK.prototype.sdkInstance.setCachedData("<em>modulename</em>", "APIRequest", <var>cacheKey</var>, <var>response</var>);
                    callback(<var>response</var>);
                }
            );
        }
        });
    };
</pre>

        <h3>Additional Functions</h3>

        <p>Create any additional functions as needed. Many modules have multiple request types and/or utility
            functions.</p>


        <h3>Internal References</h3>

        <p>Often it will be necessary for the module to reference itself and/or the CitySDK core. If this is needed, for
            consistency, the recommended solution is:</p>

        <pre>
    //References to an instance of the SDK should be called as:
    CitySDK.prototype.sdkInstance;
    //And references to this module should be called as
    CitySDK.prototype.modules.<em>modulename</em>;
</pre>

        <h3>Documentation</h3>

        <p>All modules, functions, etc. should be documented via comments using the <a href="http://usejsdoc.org/"
                                                                                       target="_blank">jsDoc notation
            (see http://usejsdoc.org/)</a>. If possible, add examples and documentation to the gh-pages site as needed
            as well.</p>

        <pre>
        /**
        * Enable function. Stores the API key for this module and sets it as enabled.
        * It will also compare the CitySDK core's version number to the minimum number
        * required as specified for this module.
        *
        * @param {string} apiKey The census API key.
        * @returns {boolean} True if enabled, false if not enabled.
        */
</pre>

        <h2>Caching</h2>

        <p>CitySDK has a caching system based on IndexedDB. It is not mandatory but is recommended as it will accelerate
            performance and reduce the request counts made to APIs (many of which may be rate-limited).</p>

        <h3>To Use The Caching System</h3>
        <ol>
            <li>Create a cache key. This is a key that can be used to request a piece of data from the cache. The extant
                modules store whole requests and responses in the cache but it can be used to store pieces of data if
                required instead of whole responses.
            </li>
            <li>Request from the cache using <code>getCachedData()</code>.</li>
            <li>If nothing is returned, make the api request and then store the result in the cache.<br/><br/>
<pre>
var <var>cacheKey</var> = "unique key to determine how to cache the returned data";

<strong>CitySDK.prototype.sdkInstance.getCachedData("<em>modulename</em>", "APIRequest", <var>cacheKey</var>,
    function (cachedData) {
    if (<var>cachedData</var> != null) {</strong>
        // Caching is enabled AND cached data is found
        /*
        You may need to use more complex logic to determine whether the cached data is valid.
        This example assumes that the source data never changes. If you are loading data from
        an api that may return different results from the same request (such as a request that
        retrieves the current weather report), add logic as needed that tests the data for
        validity beyond simple existence.
        */

        callback(<var>cachedData</var>);
        return;

        <strong>} else {</strong>

        // Caching is disabled OR no cache data is found.

        // Build the request URL as needed.
        var URL = CitySDK.prototype.modules.<em>modulename</em>.DEFAULT_ENDPOINTS.apiURL;
                // DO NOT HARDCODE A URL INTO THE FUNCTION

        // Submit the request.
        // Note there are several different request functions that can be used here.
        // See the CitySDK Core for details.
        CitySDK.prototype.sdkInstance.ajaxRequest(<var>URL</var>).done(
            function (<var>response</var>) {
                response = jQuery.parseJSON(<var>response</var>);
                CitySDK.prototype.sdkInstance.setCachedData("<em>modulename</em>", "APIRequest", <var>cacheKey</var>, <var>response</var>);
                callback(<var>response</var>);
            }
        );
    <strong>}
        });</strong>
</pre>
            </li>

        </ol>


        <h2>Creating the Request</h2>

        <p>The two inputs expected in the <code>APIRequest()</code> function are <var>request</var> and
            <var>callback</var>. It is assumed that all <code>APIRequest()</code> functions are designed around
            asynchronous principles and that the return will be a callback. Where possible, design the function to fail
            gracefully and return an error message instead of summarily crashing if the underlying API fails.</p>

        <p>The CitySDK core provides several functions to get data depending on the size of request and whether the
            underlying API supports CORS and/or JSONP. If the API doesn't support CORS and does support JSONP, use the
            <code>jsonpRequest()</code> function, otherwise use the <code>ajaxRequest()</code> or
            <code>postRequest()</code> as needed.</p>

        <h2>Adding to the Testing Page</h2>

        <p>Once the module is complete, add it to the testing pages. Each module should be testable individually and
            included in the test all modules function.</p>

        <ol>
            <li>Create a new file in <span class="text-primary">/tests/</span> with the name <span class="text-primary">test-suite.citysdk.<em>modulename</em>.js</span>
            </li>
            <li>Create a function that will run the tests that follows this structure:<br/><br/>
            <pre>
    function testNewModule() {
        var <var>moduleName</var> = "modulename";
        var <var>request</var> = {};
        var <var>response</var>;
        <var>testResultStatus[moduleName]</var> = true;
    }
</pre>
            </li>
            <li>For each function in the new module add a test input and output. If the test fails fire this
                function:<br/>
                <code>failTest(moduleName, "functioname", "error description");</code></li>
            <li>Add a link to the newly created file in <span class="text-primary">/tests/test-suite.html</span></li>
            <li>Edit the <span class="text-primary">/tests/test-suite.citysdk.js</span> file</li>
            <li>Add the newly created test function to <code>runAllTests()</code>.
                <ul>
                    <li>Add a line to the test table and connect the function in the jQuery at the bottom of the page.
                    </li>
                    <li>Run the tests and verify both positive and negative cases.</li>
                </ul>
            </li>

        </ol>

    </div>
        </div>

